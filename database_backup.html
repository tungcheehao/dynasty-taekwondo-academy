<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ›¡ï¸ æ•°æ®å¤‡ä»½ä¸æ¢å¤ - Dynasty Taekwondo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7f9fa;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #003049;
    }
    .section {
      background-color: #fff;
      padding: 20px;
      max-width: 800px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      display: inline-block;
      margin: 10px 5px;
      padding: 12px 20px;
      background-color: #005f73;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0a9396;
    }
    .log {
      background: #eef;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h2>ğŸ›¡ï¸ æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤<br>Database Backup & Restore</h2>

  <div class="section">
    <h3>ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®</h3>
    <p>æ‚¨å¯ä»¥å¯¼å‡ºæ•´ä¸ªæ•°æ®åº“ä¸º JSON æ ¼å¼æ¡£æ¡ˆï¼Œä»¥ä¾¿å‚¨å­˜æˆ–è¿ç§»ã€‚</p>
    <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®åº“</button>
  </div>

  <div class="section">
    <h3>ğŸ“¤ å¯¼å…¥å¤‡ä»½æ–‡ä»¶</h3>
    <p>ä»å·²å¤‡ä»½çš„ JSON æ–‡ä»¶è¿˜åŸæ•°æ®ã€‚âš ï¸ æ³¨æ„ï¼šæ­¤æ“ä½œå°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚</p>
    <input type="file" id="backupFile">
    <button onclick="importData()">ğŸ“¥ å¯¼å…¥å¹¶è¿˜åŸ</button>
  </div>

  <div class="section">
    <h3>ğŸ•“ æœ€è¿‘æ“ä½œè®°å½• / Recent Logs</h3>
    <div id="logList" class="log">åŠ è½½ä¸­...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOn4TMNAzchDaM2X8cQN_3GeLw4OPNPnM",
      authDomain: "dynastytkd-2d87e.firebaseapp.com",
      projectId: "dynastytkd-2d87e",
      storageBucket: "dynastytkd-2d87e.appspot.com",
      messagingSenderId: "271608799011",
      appId: "1:271608799011:web:bee1fd1bf4ee1113383696"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(async user => {
      if (!user || user.email !== "admin@dynastytkd.com") {
        alert("ä»…ä¸»ç®¡ç†å‘˜å¯è®¿é—®æ•°æ®åº“é¡µé¢");
        window.location.href = "login_register.html";
      } else {
        loadLogs();
      }
    });

    async function exportData() {
      const collections = ["students", "exams", "finance_records", "competition_results"];
      const exportData = {};

      for (const col of collections) {
        const snapshot = await db.collection(col).get();
        exportData[col] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `dynastytkd_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      await log("æ•°æ®åº“å·²å¯¼å‡º");
    }

    async function importData() {
      const file = document.getElementById("backupFile").files[0];
      if (!file) return alert("è¯·é€‰æ‹© JSON å¤‡ä»½æ–‡ä»¶");
      const text = await file.text();
      const data = JSON.parse(text);

      for (const [col, items] of Object.entries(data)) {
        for (const item of items) {
          const { id, ...rest } = item;
          await db.collection(col).doc(id).set(rest);
        }
      }

      alert("æ•°æ®åº“è¿˜åŸæˆåŠŸï¼");
      await log("æ•°æ®åº“å·²è¿˜åŸ");
    }

    async function log(action) {
      const user = auth.currentUser;
      await db.collection("logs").add({
        action,
        by: user.email,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function loadLogs() {
      db.collection("logs").orderBy("time", "desc").limit(5).onSnapshot(snapshot => {
        const logDiv = document.getElementById("logList");
        logDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const date = data.time?.toDate().toLocaleString() || "(æ— æ—¶é—´)";
          logDiv.innerHTML += `ğŸ“Œ ${data.action} by ${data.by} at ${date}<br>`;
        });
      });
    }
  </script>
</body>
</html>
