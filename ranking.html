<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç§¯åˆ†æ’è¡Œæ¦œ - Dynasty Taekwondo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h2 {
      text-align: center;
      color: #003049;
    }
    .tab {
      text-align: center;
      margin: 20px 0;
    }
    .tab button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      background-color: #005f73;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .tab button.active {
      background-color: #0a9396;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #fcd5ce;
    }
    .note {
      max-width: 800px;
      margin: 30px auto;
      font-size: 14px;
      color: #555;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <h2>ğŸ… å­¦ç”Ÿç§¯åˆ†æ’è¡Œæ¦œ / Student Ranking</h2>

  <div class="tab">
    <button onclick="switchType('å“åŠ¿ Poomsae')" class="active">å“åŠ¿</button>
    <button onclick="switchType('ç«æŠ€ Kyorugi')">ç«æŠ€</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>åæ¬¡</th>
        <th>å­¦ç”Ÿé‚®ç®±</th>
        <th>æ€»ç§¯åˆ†</th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>

  <div class="note">
    ğŸ“˜ <strong>ç§¯åˆ†è®¡ç®—è§„åˆ™ï¼š</strong><br>
    <ul>
      <li>å›½é™…èµ›äº‹ï¼š10åˆ†ï¼Œé‡‘ç‰Œ+8ã€é“¶ç‰Œ+6ã€é“œç‰Œ+4</li>
      <li>å…¨å›½èµ›äº‹ï¼š8åˆ†ï¼Œé‡‘ç‰Œ+7ã€é“¶ç‰Œ+5ã€é“œç‰Œ+3</li>
      <li>å…¨å·èµ›äº‹ï¼š6åˆ†ï¼Œé‡‘ç‰Œ+6ã€é“¶ç‰Œ+4ã€é“œç‰Œ+2</li>
      <li>é‚€è¯·èµ›ï¼š4åˆ†ï¼Œé‡‘ç‰Œ+3ã€é“¶ç‰Œ+2ã€é“œç‰Œ+1</li>
    </ul>
    ï¼ˆç§¯åˆ†æ¥è‡ªæ¯”èµ›æˆç»©è®°å½•ï¼Œå°†è‡ªåŠ¨åŒæ­¥ã€‚ï¼‰
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDOn4TMNAzchDaM2X8cQN_3GeLw4OPNPnM",
      authDomain: "dynastytkd-2d87e.firebaseapp.com",
      projectId: "dynastytkd-2d87e",
      storageBucket: "dynastytkd-2d87e.appspot.com",
      messagingSenderId: "271608799011",
      appId: "1:271608799011:web:bee1fd1bf4ee1113383696"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const body = document.getElementById("rankingBody");
    const buttons = document.querySelectorAll(".tab button");

    const levelPoints = {
      "å›½é™…èµ›äº‹": 10,
      "å…¨å›½èµ›äº‹": 8,
      "å…¨å·èµ›äº‹": 6,
      "é‚€è¯·èµ›": 4
    };

    const medalPoints = {
      "é‡‘ç‰Œ": { å›½é™…èµ›äº‹: 8, å…¨å›½èµ›äº‹: 7, å…¨å·èµ›äº‹: 6, é‚€è¯·èµ›: 3 },
      "é“¶ç‰Œ": { å›½é™…èµ›äº‹: 6, å…¨å›½èµ›äº‹: 5, å…¨å·èµ›äº‹: 4, é‚€è¯·èµ›: 2 },
      "é“œç‰Œ": { å›½é™…èµ›äº‹: 4, å…¨å›½èµ›äº‹: 3, å…¨å·èµ›äº‹: 2, é‚€è¯·èµ›: 1 }
    };

    let currentType = "å“åŠ¿ Poomsae";

    function switchType(type) {
      currentType = type;
      buttons.forEach(btn => {
        btn.classList.remove("active");
        if (btn.textContent.includes(type.split(" ")[0])) btn.classList.add("active");
      });
      loadRanking();
    }

    function loadRanking() {
      body.innerHTML = "";
      const scores = {};
      db.collection("competition_results")
        .where("category", "==", currentType)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const d = doc.data();
            const email = d.email;
            const level = d.level || "";
            const medal = d.medal || "";
            const base = levelPoints[level] || 0;
            const bonus = (medalPoints[medal] && medalPoints[medal][level]) || 0;
            const score = base + bonus;
            scores[email] = (scores[email] || 0) + score;
          });

          const sorted = Object.entries(scores)
            .sort((a, b) => b[1] - a[1]);

          if (sorted.length === 0) {
            body.innerHTML = "<tr><td colspan='3'>æš‚æ— æˆç»©è®°å½•</td></tr>";
            return;
          }

          sorted.forEach(([email, total], index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${email}</td>
              <td>${total}</td>
            `;
            body.appendChild(tr);
          });
        });
    }

    loadRanking();
  </script>
</body>
</html>
